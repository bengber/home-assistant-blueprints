#  lutron-sunnata-keypad-combination_lock.yaml - Trigger an action when a 
#      specific sequence of button clicks, double clicks, and long presses 
#      is detected on a Lutron Sunnata Keypad
#  Copyright 2026 Benjamin Engber
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

---
blueprint:
  name: Lutron Sunnata Keypad Combination Lock
  description: >
    Allow the Lutron RadioRA3 Sunnata Keypad to trigger a set of actions when
    a series of button actions (single click, double click, or long press) are
    performed in a specific order. This can create a "combination lock"
    behavior where a specific sequence of button presses is required to
    trigger an action.

    **NOTE:** To use long press and double click handlers for buttons other
    than Raise/Lower, set the button behavior to Single Action in the Lutron
    designer software.
  domain: automation
  homeassistant:
    min_version: "2024.6.0"
  input:
    sunnata_keypad:
      name: Sunnata Keypad
      description: The Lutron Sunnata keypad to control
      selector:
        device:
          filter:
            - integration: lutron_caseta
              model: RRST-W2B-XX (SunnataKeypad)
            - integration: lutron_caseta
              model: RRST-HN2B-XX (SunnataHybridKeypad)
            - integration: lutron_caseta
              model: RRST-W3RL-XX (SunnataKeypad)
            - integration: lutron_caseta
              model: RRST-HN3RL-XX (SunnataHybridKeypad)
            - integration: lutron_caseta
              model: RRST-W4B-XX (SunnataKeypad)
            - integration: lutron_caseta
              model: RRST-HN4B-XX (SunnataHybridKeypad)
          multiple: false
    passcode_sequence:
      name: Passcode Sequence
      description: >
        The sequence of button actions that will trigger the automation. Each
        action should be separated by a comma.
        Valid actions include:
        - button_1_single_click
        - button_1_double_click
        - button_1_long_press
        - button_raise_single_click
        - button_raise_double_click (etc.)
      selector:
        text:
          multiline: true
    passcode_matched_action:
      name: Passcode Matched Action
      description: >-
        Action to perform when the assembled `passcode_progress` equals the
        configured `passcode_sequence`.
      default: []
      selector:
        action: {}
    passcode_progress:
      name: Passcode In-Progress
      description: >-
        The passcode string currently being constructed by this blueprint.
        Select an `input_text` helper to store/read the in-progress passcode.
      selector:
        entity:
          domain: input_text
    last_press_time:
      name: Last Press Time
      description: >-
        Timestamp of the last button press. Select an `input_datetime` helper
        (with time) so templates can store the press time and read it back.
      selector:
        entity:
          domain: input_datetime
    advanced_settings_group:
      name: "Advanced Settings"
      icon: mdi:cog
      collapsed: true
      input:
        long_press_timeout:
          name: Long Press Timeout
          description: How long (in milliseconds) before a press becomes a long press
          default: 500
          selector:
            number:
              min: 100
              max: 2000
              step: 50
              unit_of_measurement: "ms"
        double_click_timeout:
          name: Double Click Timeout
          description: Maximum time (in milliseconds) between clicks for double-click detection
          default: 250
          selector:
            number:
              min: 100
              max: 1000
              step: 50
              unit_of_measurement: "ms"
        next_in_sequence_timeout:
          name: Next-In-Sequence Timeout
          description: >-
            Time (in seconds) allowed between sequence steps before the
            passcode resets.
          default: 2
          selector:
            number:
              min: 1
              max: 10
              step: 1
              unit_of_measurement: "s"

trigger_variables:
  sunnata_keypad_device: !input sunnata_keypad

triggers:
  - trigger: event
    event_type: lutron_caseta_button_event
    event_data:
      device_id: "{{ sunnata_keypad_device }}"
      action: press
    variables:
      leap_number: leap_{{ trigger.event.data.leap_button_number }}
      original_leap_button_number: "{{ trigger.event.data.leap_button_number }}"
      leap_trigger_type: "{{ trigger.event.data.action }}"
      original_press_start_time: "{{ trigger.event.time_fired }}"

conditions: []

variables:
  long_press_timeout: !input long_press_timeout
  double_click_timeout: !input double_click_timeout
  passcode_sequence: !input passcode_sequence
  # Normalize and validate the configured passcode sequence
  normalized_passcode_sequence: '{{ passcode_sequence | regex_replace("\\s+", "") }}'
  # Check for any invalid tokens in the passcode sequence
  invalid_token: >-
    {% set parts = (
      normalized_passcode_sequence.split(',') if normalized_passcode_sequence != '' else []
    ) %}
    {% for p in parts %}
      {% if p not in [
        'button_1_single_click',
        'button_1_double_click',
        'button_1_long_press',
        'button_2_single_click',
        'button_2_double_click',
        'button_2_long_press',
        'button_3_single_click',
        'button_3_double_click',
        'button_3_long_press',
        'button_4_single_click',
        'button_4_double_click',
        'button_4_long_press',
        'button_lower_single_click',
        'button_lower_double_click',
        'button_lower_long_press',
        'button_raise_single_click',
        'button_raise_double_click',
        'button_raise_long_press',
      ] %}
        {{ p }}
        {% break %}
      {% endif %}
    {% endfor %}
  passcode_progress: !input passcode_progress
  last_press_time: !input last_press_time
  next_in_sequence_timeout: !input next_in_sequence_timeout

actions:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ invalid_token != '' }}"
        sequence:
          - service: persistent_notification.create
            data:
              title: "Passcode configuration error"
              message: "Invalid action in passcode_sequence: {{ invalid_token }}"
      - conditions:
          - condition: template
            value_template: "{{ invalid_token == '' }}"
        sequence:
          - if:
              - condition: template
                value_template: >-
                  {# Only perform the timeout check if there is existing progress; otherwise
                     treat as fresh start #}
                  {{ (states(passcode_progress) | default('') != '') and
                     (states(last_press_time) is not none) and
                     (as_timestamp(states(last_press_time)) > 100000) and
                     ((as_timestamp(now()) - as_timestamp(states(last_press_time))) >
                      next_in_sequence_timeout) }}
            then:
              # Timeout has expired since last button press, clear progress and start again
              - service: input_text.set_value
                target:
                  entity_id: !input passcode_progress
                data:
                  value: ""
              - service: input_datetime.set_datetime
                target:
                  entity_id: !input last_press_time
                data:
                  datetime: "1970-01-01 00:00:00+0000"
              - service: persistent_notification.create
                data:
                  title: "Keypad passcode timeout"
                  message: "Passcode sequence timed out â€” progress cleared."
            else:
              # Wait for release to detect long press
              - wait_for_trigger:
                  - trigger: event
                    event_type: lutron_caseta_button_event
                    event_data:
                      device_id: "{{ sunnata_keypad_device }}"
                      leap_button_number: "{{ original_leap_button_number }}"
                      action: release
                timeout:
                  milliseconds: "{{ long_press_timeout }}"
              - choose:
                  # Long press detected (timeout expired)
                  - conditions:
                      - condition: template
                        value_template: >- 
                          {# No release detected, we're in a long press #}
                          {{ not wait.trigger }}
                    sequence:
                      - service: input_text.set_value
                        target:
                          entity_id: !input passcode_progress
                        data:
                          value: >-
                            {% set current = states(passcode_progress) | default('') %}
                            {{ current ~ (',' if current | length > 0 else '') ~ (
                               {
                                 'leap_1':'button_1_long_press',
                                 'leap_2':'button_2_long_press',
                                 'leap_3':'button_3_long_press',
                                 'leap_4':'button_4_long_press',
                                 'leap_18':'button_lower_long_press',
                                 'leap_19':'button_raise_long_press'
                               }[leap_number]) }}
                      - service: input_datetime.set_datetime
                        target:
                          entity_id: !input last_press_time
                        data:
                          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
                # Not a long press, check for double-click
                default:
                  # Wait for second press
                  - wait_for_trigger:
                      - trigger: event
                        event_type: lutron_caseta_button_event
                        event_data:
                          device_id: "{{ sunnata_keypad_device }}"
                          leap_button_number: "{{ original_leap_button_number }}"
                          action: press
                    timeout:
                      milliseconds: "{{ double_click_timeout }}"
                  - choose:
                      # Single click (no second press detected)
                      - conditions:
                          - condition: template
                            value_template: >-
                              {# We didn't detect a second press. It's a single click. #}
                              {{ not wait.trigger }}
                        sequence:
                          - service: input_text.set_value
                            target:
                              entity_id: !input passcode_progress
                            data:
                              value: >-
                                {% set current = states(passcode_progress) |
                                   default('') %}
                                {{ current ~ (',' if current | length > 0 else '') ~ (
                                   {
                                     'leap_1':'button_1_single_click',
                                     'leap_2':'button_2_single_click',
                                     'leap_3':'button_3_single_click',
                                     'leap_4':'button_4_single_click',
                                     'leap_18':'button_lower_single_click',
                                     'leap_19':'button_raise_single_click'
                                   }[leap_number]) }}
                    # Second press detected, wait for release
                    default:
                      - wait_for_trigger:
                          - trigger: event
                            event_type: lutron_caseta_button_event
                            event_data:
                              device_id: "{{ sunnata_keypad_device }}"
                              leap_button_number: "{{ original_leap_button_number }}"
                              action: release
                        timeout:
                          milliseconds: "{{ long_press_timeout }}"
                      - choose:
                          # Long press on second click
                          - conditions:
                              - condition: template
                                value_template: >-
                                  {# We didn't release the second press in time. Let's treat that as a long click. #}
                                  {{ not wait.trigger }}
                            sequence:
                              - service: input_text.set_value
                                target:
                                  entity_id: !input passcode_progress
                                data:
                                  value: >-
                                    {% set current = states(passcode_progress) | default('') %}
                                    {{ current ~ (',' if current | length > 0 else '') ~ (
                                       {
                                         'leap_1':'button_1_long_press',
                                         'leap_2':'button_2_long_press',
                                         'leap_3':'button_3_long_press',
                                         'leap_4':'button_4_long_press',
                                         'leap_18':'button_lower_long_press',
                                         'leap_19':'button_raise_long_press'
                                       }[leap_number]) }}
                        # Double click confirmed
                        default:
                          - service: input_text.set_value
                            target:
                              entity_id: !input passcode_progress
                            data:
                              value: >-
                                {% set current = states(passcode_progress) | default('') %}
                                {{ current ~ (',' if current | length > 0 else '') ~ (
                                   {
                                     'leap_1':'button_1_double_click',
                                     'leap_2':'button_2_double_click',
                                     'leap_3':'button_3_double_click',
                                     'leap_4':'button_4_double_click',
                                     'leap_18':'button_lower_double_click',
                                     'leap_19':'button_raise_double_click'
                                   }[leap_number]) }}

          - service: input_datetime.set_datetime
            target:
              entity_id: !input last_press_time
            data:
              datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ (states(passcode_progress) | default('')) != '' and
                         not normalized_passcode_sequence.startswith(states(passcode_progress)) }}
                sequence:
                  - service: persistent_notification.create
                    data:
                      title: "Keypad passcode progress reset"
                      message: >-
                        Passcode progress "{{ states(passcode_progress) | default('') }}"
                        does not match the start of the configured passcode sequence and has been reset.
                  - service: input_text.set_value
                    target:
                      entity_id: !input passcode_progress
                    data:
                      value: ""
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: !input last_press_time
                    data:
                      datetime: "1970-01-01 00:00:00+0000"
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ (states(passcode_progress) | default('')) != '' and
                         (states(passcode_progress) | default('')) ==
                         normalized_passcode_sequence }}
                sequence:
                  - sequence: !input passcode_matched_action
                  - service: input_text.set_value
                    target:
                      entity_id: !input passcode_progress
                    data:
                      value: ""
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: !input last_press_time
                    data:
                      datetime: "1970-01-01 00:00:00+0000"
                  - service: persistent_notification.create
                    data:
                      title: "Keypad passcode matched"
                      message: "Passcode sequence matched and action executed."

          - service: persistent_notification.create
            data:
              title: "Keypad passcode progress"
              message: "Current passcode_progress: {{ states(passcode_progress) | default('') }}"

mode: single